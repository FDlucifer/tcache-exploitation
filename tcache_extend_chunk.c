#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <string.h>

struct malloc_chunk {
	size_t prev_size;
	size_t size;
	struct {
		struct malloc_chunk *fd;
		union {
			struct malloc_chunk *bk;
			char buf[100];
		};
	};
};

#define mem2chunk(m) \
	( (struct malloc_chunk*)((char*)m - offsetof(struct malloc_chunk, fd)) )
#define chunk2mem(c) \
	( (void*)((char*)c + offsetof(struct malloc_chunk, fd)) )

#define size2request(sz) (sz - 2*sizeof(size_t))
int main(void)
{
	printf("Extend chunk to get overlapping, without tcache -> double free or corruption\n");
	void *victim = malloc(0x20);	
	void *overlap = malloc(0x20);	

	printf(" content at the beginning : %s\n", overlap);
	mem2chunk(victim)->size = 0x100;
	free(victim);
	void *evil = malloc(size2request(0x100));
	memset(evil, 'A', size2request(0x100));

	printf(" overlap chunk content now : %.20s\n", overlap);
	return 0;
}
